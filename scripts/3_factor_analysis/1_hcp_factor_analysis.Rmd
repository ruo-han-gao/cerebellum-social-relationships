---
title: "HCD Factor Analysis"
author: "Ruohan Gao"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clear the environment
rm(list = ls())
options(scipen = 999, digits = 3)

workdir = "/data/tu_gaor/scripts"
homedir = "/Users/ruohan/My_Repos/Cerebellum"
cwd_dir = homedir
datadir = file.path(cwd_dir, "dat")

aging_name = "hcpa"
develop_name = "hcpd"

plot_dir = file.path(cwd_dir, "plotting/factor_analysis_plots")

# rmarkdown::run("hcp_factor_analysis.Rmd")
# rmarkdown::render("1_hcp_factor_analysis.Rmd")
```


```{r load packages, message=FALSE}
library(psych)
library(nFactors)
library(tidyr)
library(dplyr)
library(corrplot)
library(RColorBrewer)
library(lavaan)
library(semTools)
library(tibble)
library(ggplot2)
```

----------

## 1  Load data and discriptives

```{r prepare data, warning=FALSE, message=FALSE}
dat_a = read.csv(file.path(datadir, aging_name, "fusion_yeo7_17_socialscore_n590.csv"))
dat_d = read.csv(file.path(datadir, develop_name, "fusion_yeo7_17_socialscore_n443.csv"))

# combine the two datasets
dat <- rbind(dat_a, dat_d)

soc_item22 = dat[, 85:106]
item.labels = colnames(soc_item22)

describe(soc_item22)
```

----------

## 2  Why factor analysis?

We extract 22 items from social health surveys, covering 5 aspects - emotional and instrumental support, friendship, loneliness, perceived rejection, and perceived hostility. Among them, the first 2 assess positive experiences, while later 3 assess negative ones. Therefore, responses to negatively worded items were reverse-coded.

Giving that the items may capture overlapping aspects of social health, factor analyses, as a data-driven approach to uncover how items naturally cluster, were employed to examine the underlying constructs of the included survey items.

----------

## 3  Correlation matrix

```{r correlation matrix, warning=FALSE}
poly_R <- polychoric(soc_item22)$rho

png(file.path(plot_dir, paste0("all", "_items_cor_matrix.png")), 
    width=6, height=6, units="in", res=300)

corrplot(poly_R, method = "square",
         order = "hclust",
         tl.col = "black",
         # addCoef.col = "black",
         tl.cex = 1.2,        # axis label font
         cl.cex = 1.2,        # color bar number size
         family = "Arial",
         col = colorRampPalette(rev(brewer.pal(11, "RdBu")))(200))
dev.off()
```

----------

## 4  Factorability checks

### 4.1  Sampling adequacy

Two diagnostic tests `KMO()` and `cortest.bartlett()` were used to determine whether the data is suitable for factor analysis.

```{r kmo}
KMO(soc_item22)
range(KMO(soc_item22)[2])
```

The `KMO()` function performs the Kaiser-Meyer-Olkin (KMO) Measure of Sampling Adequacy. It answers the question: _“Do the variables share enough common variance to extract underlying factors?”_

  - Using the `KMO()` function, an overall MSA 0.88 was obtained, which falls into the “meritorious” range according to Kaiser’s classification, indicating that the correlations among our variables are sufficiently strong and suitable for factor analysis.
  - The individual KMO values for variables ranged from 0.79 to 0.91, showing that all the items contributed adequately to the overall sampling adequacy and that none should be excluded based on this criterion.

### 4.2  Test of sphericity

```{r cortest}
cortest.check = cortest.bartlett(poly_R, n = nrow(dat))
cat("Chi-square:", cortest.check$chisq, "| df:", cortest.check$df, "| p-value:", cortest.check$p.value, "\n")
```

The `cortest.bartlett()` performs Bartlett's test of sphericity to assess the factorability of the correlation matrix. Simply put - if the correlation matrix is significantly different from an identity matrix, where variables are uncorrelated).

  - It answers the question: _“Are there meaningful correlations among variables?”_
  - A p value of 0 indicated that our variables are correlated enough to justify factor analysis.

----------

## 5  Exploratory factor analysis (EFA)

```{r efa model fit indices}
fa.stats <- function(efa.model) {
  model_name <- deparse(substitute(efa.model))
  
  stats <- c(
    Chi_Square = round(efa.model$STATISTIC, 3),
    p_value = round(efa.model$PVAL, 3),
    TLI = round(efa.model$TLI, 3),
    RMSEA = round(efa.model$RMSEA[1], 3),
    RMSEA_CI_Lower = round(efa.model$RMSEA[2], 3),
    RMSEA_CI_Upper = round(efa.model$RMSEA[3], 3),
    BIC = round(efa.model$BIC, 3)
  )

  return(stats)
}
```

### 5.1  EFA models

#### EFA with 4 factors

```{r efa 4fas}
efa.4fas <- fa(poly_R, n.obs = nrow(dat), nfactors = 4, fm = "pa", rotate = "promax")
fa.stats(efa.4fas)
print(efa.4fas$loadings, cutoff = 0.3)
range(efa.4fas$communality)
efa.4fas$Phi
```

```{r plot efa 4fas results}
fa.diagram(efa.4fas, rsize = 1)
```

#### EFA with 5 factors

```{r efa 3 fas}
efa.5fas <- fa(poly_R, n.obs = nrow(dat), nfactors = 5, fm = "pa", rotate = "promax")
fa.stats(efa.5fas)
print(efa.5fas$loadings, cutoff = 0.3)
range(efa.5fas$communality)
efa.5fas$Phi
```

```{r plot efa 3fas results}
fa.diagram(efa.5fas, rsize = 1)
```

#### EFA with 1 factor

```{r efa 1 fa}
efa.1fa <- fa(poly_R, n.obs = nrow(dat), nfactors = 1, fm = "pa", rotate = "oblimin")
fa.stats(efa.1fa)
print(efa.1fa$loadings, cutoff = 0.3) 

range(efa.1fa$communality)
```

#### EFA model summary

```{r}
efa.model.list <- list(
  efa.5fas = fa.stats(efa.5fas),
  efa.4fas = fa.stats(efa.4fas),
  efa.1fa = fa.stats(efa.1fa))

efa.summary <- do.call(rbind, efa.model.list)
print(efa.summary)
```


### 5.2  Cronbach’s alpha for factor reliability

Factor internal consistency was evaluated using Cronbach’s alpha, one of the most common measures of internal consistency reliability (how well a set of items measures a single underlying construct).

```{r reliability Analysis}
factor.structure <- list(
  sr = soc_item22,
  hostility = soc_item22[, c("hos268", "hos267", "hos263", "hos262", "hos270")],
  emosup = soc_item22[, c("emo200", "emo203", "emo205", "emo222", "emo216")],
  friends = soc_item22[, c("fri230", "fri233", "fri237", "fri239", "fri247")],
  isolation = soc_item22[, c("lon260", "lon261", "lon253", "lon254", "rej276", "rej279", "rej281")],
  loneliness = soc_item22[, c("lon260", "lon261", "lon253", "lon254")],
  rejection = soc_item22[, c("rej276", "rej279", "rej281")]
)

get_alpha_summary <- function(df) {
  alpha.result <- psych::alpha(df)
  return(c(
    n_items = ncol(df),
    alpha = round(alpha.result$total$raw_alpha, 2)
  ))
}

alpha_summary <- t(sapply(factor.structure, get_alpha_summary))

alpha_summary <- as.data.frame(alpha_summary)
alpha_summary$Reliability <- cut(
  alpha_summary$alpha,
  breaks = c(-Inf, 0.7, 0.8, 0.9, Inf),
  labels = c("Poor", "Acceptable", "Good", "Excellent")
)

print(alpha_summary)
```

### 5.3 One-factor EFA results

We explored the factor structure of the social health variables using exploratory factor analysis (EFA). A four- or five-factor solution emerged, with moderately correlated factors, suggesting the presence of a potential general construct. 

To assess the extent to which a single general factor could account for the common variance among the items. We fit a unidimensional model with one factor (social relationship). In this model, all items demonstrated meaningful loadings on the single factor (all > 0.35), particularly those from the Rejection and Loneliness domains (most > 0.60). This general factor accounted for a substantial proportion of variance (> 30%) and exhibited strong internal consistency (Cronbach’s α > 0.8).

#### Loading of social relationship

```{r plot g loadings, warning=FALSE}
loadings <- as.data.frame(efa.1fa$loadings[])

loadings_df <- loadings %>%
  rownames_to_column("Item")

colnames(loadings_df)[2] <- "Loading"

ggplot(loadings_df, aes(x = reorder(Item, Loading), y = Loading, fill = Loading)) +
  geom_col(width = 0.6) +
  coord_flip() +
  scale_fill_gradient(low = "#FFE0B2", high = "#E65100") +
  theme_minimal(base_size = 12) +
  labs(title = "EFA loadings",
       x = "Item",
       y = "",
       fill = "Loading") +
  theme(
    axis.title = element_text(size = 14, family = "Arial"),
    axis.text = element_text(size = 12, color = "black", family = "Arial"),
    legend.text = element_text(size = 12, family = "Arial"),
    legend.title = element_text(size = 12, family = "Arial"),
    panel.grid = element_blank()
  )

ggsave(file.path(plot_dir, paste0("hcp", "_sr_factor_loadings.png")),
       width = 4, height = 5, dpi = 300)

```


### 5.4 Export EFA sr score

```{r get 1fa efa score}
efa.1fa.scores = factor.scores(soc_item22, efa.1fa, method = "regression")
efa.sr_score = efa.1fa.scores$scores

colnames(efa.sr_score) = "sr"

ggplot(data.frame(efa.sr_score), aes(x = efa.sr_score)) +
  geom_density(fill = "cadetblue3", alpha = 0.6, color = "darkslategray", linewidth = 0.5) +
  labs(
    title = "",
    x = "SR score",
    y = "Density"
  ) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 11, color = "black", family = "Arial"),
    axis.text  = element_text(size = 11, color = "black", family = "Arial"),
    legend.text  = element_text(size = 11, family = "Arial"),
    legend.title = element_text(size = 11, family = "Arial"),
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA)
  )

ggsave(
  file.path(plot_dir, paste0("all", "_efa_sr_density.png")),
  width = 3, height = 2.5, dpi = 300
)
```

```{r combine efa g scores, warning=FALSE}
cerebel_cerebr_social_sr = bind_cols(dat, efa.sr_score)

output_file <- file.path(datadir, paste0("hcp_cerebel_cerebr_social_sr_n", nrow(dat), ".csv"))
write.csv(cerebel_cerebr_social_sr, output_file, row.names = FALSE)
```


## 6 Group difference of social relationship score

### 6.1 Comparison between HCP-D and HCP-A

- no significance between the HCA and HCD groups.

```{r group difference, warning=FALSE}
group_data <- cerebel_cerebr_social_facors %>%
  mutate(subject = gsub("[0-9]", "", subject)) %>%   # keep letters only
  rename(group = subject)

group_data$group <- as.factor(group_data$group)

group_data %>%
  group_by(group) %>%
  summarise(
    mean = mean(sr, na.rm = TRUE),
    sd   = sd(sr, na.rm = TRUE)
  )
```


```{r t test for between cohorts}
var.test(sr ~ group, data = group_data)

t_results = t.test(sr ~ group, data = group_data)
t_results
```

```{r linear model for between cohorts}
mod_sr = lm(sr ~ group, data = group_data)
summary(mod_sr)

```

```{r hcpa and hcpd, warning=FALSE}
# write HCP-D data
hcpd_data <- group_data %>%
  filter(group == "HCD")

output_file <- file.path(datadir, develop_name, paste0(develop_name, "_brain_social_factors_n", nrow(hcpd_data), ".csv"))
write.csv(hcpd_data, output_file, row.names = FALSE)

# write HCP-A data
hcpa_data <- group_data %>%
  filter(group == "HCA")

output_file <- file.path(datadir, aging_name, paste0(aging_name, "_brain_social_factors_n", nrow(hcpa_data), ".csv"))
write.csv(hcpa_data, output_file, row.names = FALSE)
```

```{r mean and sd in hcpd}
hcpd_data %>%
  group_by(sex) %>%
  summarise(
    mean = mean(sr, na.rm = TRUE),
    sd   = sd(sr, na.rm = TRUE)
  )
```

```{r mean and sd in hcpa}
hcpa_data %>%
  group_by(sex) %>%
  summarise(
    mean = mean(sr, na.rm = TRUE),
    sd   = sd(sr, na.rm = TRUE)
  )
```


### 6.2 Comparison between females and males in each dataset

```{r equal variance between cohorts}
var.test(sr ~ sex, data = hcpd_data)
var.test(sr ~ sex, data = hcpa_data)
```

```{r}
t_sex_hcpd = t.test(sr ~ sex, var.equal = TRUE, data = hcpd_data)
t_sex_hcpd
```

```{r}
t_sex_hcpa = t.test(sr ~ sex, var.equal = TRUE, data = hcpa_data)
t_sex_hcpa
```

